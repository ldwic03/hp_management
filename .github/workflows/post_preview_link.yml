# This is a workflow to preview branches

name: Post_Preview_Link

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  pull_request:
    types: opened

jobs:
  post_preview_link:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    steps:
    - name: Create the comment
      env:
        PREVIEW_ROOT: https://oumpy.github.io/previews
      run: |
        echo "A preview of the PR branch `${GITHUB_REF}` is found at:" >> comment
        echo "${PREVIEW_ROOT}/${GITHUB_REF}/" >> comment
        echo "(if it is successfully compiled and deployed)"
        sed -i -z 's/\n/\\n/g' comment

    - name: Post the comment
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        URL: ${{ github.event.pull_request.comments_url }}
      run: |
        curl -X POST \
             -H "Authorization: token ${GITHUB_TOKEN}" \
             -d "{\"body\": \"$(cat comment)\"}" \
             ${URL}
